<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Analysis Dashboard</title>
    <style>
        /* üåê Base Layout (Full Page Centering) */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1a1a2e;
            height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        /* üì¶ Main Container (Video + Chat) */
        .app-container {
            display: flex;
            flex-direction: row;
            width: 90%;
            height: 90%;
            gap: 15px;
            box-sizing: border-box;
            background: rgb(223, 214, 214);
            border-radius: 5px;
            padding: 15px;
            
            
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }

        /* üé• Left: Video Panel */
        .video-panel {
            flex: 1;
            background: #0f3460;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 50%;
            min-height: 50%;
        }

        /* üì∫ Video Container (Webcam View) - FIXED */
        .video-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            position: relative;
            min-height: 400px;
            border-bottom: 2px solid #1a1a2e;
        }

        #userVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        /* Summary Panel */
        .summary-panel {
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin: 15px;
            color: white;
        }

        .summary-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 15px;
            text-align: center;
            color: #ffcc00;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .summary-label {
            font-weight: 600;
        }

        .summary-value {
            color: #25D366;
        }

        /* üïπÔ∏è Sticky Controls (Buttons) */
        .controls {
            width: 100%;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 15px;
            background: #0f3460;
            z-index: 10;
            gap: 10px;
        }

        /* üîò Buttons Style */
        .controls button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            min-width: 110px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        #startBtn { 
            background: linear-gradient(to right, #25D366, #1ebe5e); 
            color: white; 
        }
        #startBtn:hover {
            background: linear-gradient(to right, #1ebe5e, #189e4d);
            transform: translateY(-2px);
        }
        
        #nextBtn { 
            background: linear-gradient(to right, #3498db, #2980b9); 
            color: white; 
        }
        #nextBtn:hover {
            background: linear-gradient(to right, #2980b9, #2573a7);
            transform: translateY(-2px);
        }
        
        #submitBtn { 
            background: linear-gradient(to right, #128C7E, #0e766a); 
            color: white; 
        }
        #submitBtn:hover {
            background: linear-gradient(to right, #0e766a, #0c6157);
            transform: translateY(-2px);
        }
        
        .controls button:disabled {
            background: #555;
            color: #999;
            cursor: not-allowed;
            transform: none;
        }

        /* üí¨ Right: Chat Panel */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0f3460;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .chat-header {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            background: linear-gradient(to right, #128C7E, #0e766a);
            color: white;
            font-weight: 600;
            font-size: 20px;
            letter-spacing: 0.5px;
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #1a1a2e;
        }

        .chat-messages::-webkit-scrollbar { width: 8px; }
        .chat-messages::-webkit-scrollbar-thumb { 
            background: #128C7E; 
            border-radius: 5px; 
        }
        .chat-messages::-webkit-scrollbar-thumb:hover { background: #0e766a; }

        .message { 
            max-width: 75%; 
            padding: 12px 16px; 
            border-radius: 10px; 
            word-wrap: break-word; 
            line-height: 1.5;
        }
        .user { 
            background: linear-gradient(to right, #25D366, #1ebe5e);
            align-self: flex-end; 
            color: #0c3c21;
        }
        .system { 
            background: linear-gradient(to right, #e0e0e0, #f0f0f0);
            align-self: flex-start; 
            color: #333;
        }

        .question-display {
            padding: 15px;
            background: #1a1a2e;
            border-top: 2px solid #0f3460;
            font-weight: 600;
            text-align: center;
            color: white;
            font-size: 18px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .note {
            color: #ffcc00;
            font-weight: bold;
            text-align: center;
            font-size: 14px;
            margin: 10px;
            padding: 10px;
            background: rgba(255, 204, 0, 0.1);
            border-radius: 8px;
        }

        /* Timer Display */
        .timer-display {
            font-weight: bold;
            font-size: 18px;
            color: #ffcc00;
            text-align: center;
            margin: 15px 0;
            position: relative;
            padding: 10px;
            background: rgba(255, 204, 0, 0.1);
            border-radius: 8px;
        }

        /* Timer Progress Bar */
        .timer-bar-container {
            width: 90%;
            height: 20px;
            background-color: #1a1a2e;
            border-radius: 10px;
            margin: 10px auto;
            overflow: hidden;
            border: 1px solid #0f3460;
        }

        .timer-bar {
            height: 100%;
            background: linear-gradient(to right, #25D366, #ffcc00, #ff3333);
            width: 100%;
            transition: width 1s linear;
            border-radius: 10px;
        }

        /* Custom Alert Modal CSS */
        #customAlert {
            display: none;
            position: fixed;
            top:0; left:0;
            width:100%; height:100%;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #customAlert .alert-box {
            background: linear-gradient(to bottom, #0f3460, #1a1a2e);
            padding: 30px 40px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            border: 1px solid #128C7E;
            max-width: 400px;
            width: 80%;
        }
        #customAlert p {
            margin-bottom: 25px;
            font-size: 18px;
            color: white;
            line-height: 1.5;
        }
        #customAlert button {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            background: linear-gradient(to right, #25D366, #1ebe5e);
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        #customAlert button:hover {
            background: linear-gradient(to right, #1ebe5e, #189e4d);
            transform: translateY(-2px);
        }

        /* Status indicator */
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-recording {
            background-color: #ff3333;
            box-shadow: 0 0 8px #ff3333;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
           100% { opacity: 1; }
        }
        
        /* Loading indicator */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Subject info */
        .subject-info {
            color: #ffcc00;
            text-align: center;
            font-size: 14px;
            margin: 5px 0;
            padding: 8px;
            background: rgba(255, 204, 0, 0.1);
            border-radius: 6px;
        }
        
        /* Current subject display */
        .current-subject {
            background: rgba(255, 204, 0, 0.2);
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
            color: #ffcc00;
            border: 1px solid #ffcc00;
        }
        
        .subject-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .subject-details {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #ddd;
        }
        
        /* Question display in chat */
        .question-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 8px;
            margin: 5px 0;
            border-left: 3px solid #34db7a;
        }
        
        .question-item.current {
            background: rgba(52, 152, 219, 0.2);
            border-left: 3px solid #ffcc00;
        }
        
        .question-item.completed {
            background: rgba(37, 211, 102, 0.1);
            border-left: 3px solid #25D366;
        }
        
        .question-text {
            font-size: 14px;
            color: #ddd;
        }
        
        /* Subjects list in summary */
        .subjects-list {
            margin-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            padding-top: 15px;
        }
        
        .subjects-list-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #ffcc00;
            text-align: center;
        }
        
        .subject-summary {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 13px;
        }
        
        .subject-name {
            font-weight: 600;
        }
        
        .subject-stats {
            color: #25D366;
        }
        
        /* Responsive design */
        @media (max-width: 1200px) {
            .app-container {
                flex-direction: column;
                height: 98%;
            }
            
            .video-panel, .chat-container {
                min-width: 100%;
                max-height: 50%;
            }
            
            .question-display {
                min-height: 80px;
                font-size: 16px;
                padding: 10px;
            }
        }
        
        @media (max-width: 768px) {
            .app-container {
                width: 98%;
                padding: 10px;
            }
            
            .controls button {
                padding: 10px 15px;
                font-size: 14px;
                min-width: 90px;
            }
            
            .question-display {
                font-size: 15px;
                min-height: 70px;
            }
            
            .timer-display {
                font-size: 16px;
            }
            
            .current-subject {
                padding: 10px;
            }
            
            .subject-title {
                font-size: 16px;
            }
            
            .summary-panel {
                padding: 10px;
                margin: 10px;
            }
            
            .summary-title {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>

<div class="app-container">

    <!-- üé• Left side: Video & Controls -->
    <div class="video-panel">
        <div class="video-container">
            <video id="userVideo" autoplay muted></video>
        </div>

        

        <!-- Timer Display -->
        <div class="timer-display">
            <span class="status-indicator" id="statusIndicator"></span>
            ‚è∞ Time Remaining: <span id="timerText">--:--</span>
            <div id="timerInfo" class="subject-info">Click Start Button to begin all subjects</div>
            <div class="timer-bar-container">
                <div class="timer-bar" id="timerBar"></div>
            </div>
        </div>

        <div class="controls">
            <button id="startBtn">Start</button>
            <button id="nextBtn" disabled>Next</button>
            <button id="submitBtn" disabled>Submit</button>
        </div>

        <div id="result"></div>
    </div>

    <!-- üí¨ Right side: Chat -->
    <div class="chat-container">
        <div class="chat-header">AI Interview Assistant</div>
        <div class="chat-messages" id="chatMessages">
            <div class="note">
                üéß Note: Please use headphones for best audio clarity during the interview.
            </div>
            <!-- Summary Panel -->
        <div class="summary-panel" id="summaryPanel">
            <div class="summary-title">Interview Summary</div>
            <div class="summary-item">
                <span class="summary-label">Total Subjects:</span>
                <span class="summary-value" id="totalSubjects">--</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Total Questions:</span>
                <span class="summary-value" id="totalQuestions">--</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Total Time:</span>
                <span class="summary-value" id="totalTime">--</span>
            </div>
            <div class="subjects-list" id="subjectsList">
                <div class="subjects-list-title">Subjects Included:</div>
                <!-- Subjects will be listed here -->
            </div>
        </div>
           

            
            <!-- Current subject and questions will be inserted here -->
            <div id="currentSubjectContainer"></div>
        </div>

        <div class="question-display" id="currentQuestion">
            <!-- Current question will be displayed here -->
            Click Start to begin. Questions will continue automatically through all subjects.
        </div>
    </div>
</div>
<!--  Custom Alert Modal -->
<div id="customAlert">
    <div class="alert-box">
        <p id="alertMessage">Message here</p>
        <button id="alertOkBtn">OK</button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        //  BACK & REFRESH HANDLING START 
        if (!sessionStorage.getItem("fromInstruction")) {
            window.location.replace("index.html");
        }

        // On load, set current page as fromInstruction
        window.onload = function() {
            sessionStorage.setItem("fromInstruction", "true");
            // Replace history to prevent back to previous pages
            history.replaceState(null, null, "dashboard.html");
        };

        // Back button handle karna
        window.addEventListener('popstate', function() {
            window.location.replace("index.html");
        });

        // Optional: refresh handling
        window.addEventListener('beforeunload', function() {
            sessionStorage.removeItem("fromInstruction");
        });
        //  BACK & REFRESH HANDLING END 

        //  Custom Alert Elements 
        const customAlert = document.getElementById('customAlert');
        const alertMessage = document.getElementById('alertMessage');
        const alertOkBtn = document.getElementById('alertOkBtn');

        //  Function to show alert 
        function showAlert(message) {
            alertMessage.textContent = message; // Set message
            customAlert.style.display = 'flex'; // Show modal
        }

        //  OK button hides the alert 
        alertOkBtn.addEventListener('click', () => {
            customAlert.style.display = 'none';
        });

        //  DOM Elements: Fetching elements after DOM is fully loaded
        const videoElement = document.getElementById('userVideo');
        const startBtn = document.getElementById('startBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');
        const chatMessages = document.getElementById('chatMessages');
        const currentQuestion = document.getElementById('currentQuestion');
        const statusIndicator = document.getElementById('statusIndicator');
        const timerInfo = document.getElementById('timerInfo');
        const timerText = document.getElementById('timerText');
        const timerBar = document.getElementById('timerBar');
        const currentSubjectContainer = document.getElementById('currentSubjectContainer');
        const summaryPanel = document.getElementById('summaryPanel');
        const totalSubjectsEl = document.getElementById('totalSubjects');
        const totalQuestionsEl = document.getElementById('totalQuestions');
        const totalTimeEl = document.getElementById('totalTime');
        const subjectsListEl = document.getElementById('subjectsList');

        let allQuestions = []; // All questions from all subjects
        let currentSubjectIndex = 0;
        let currentQuestionIndex = 0;
        let timerDuration = 0; // Total time for all subjects
        let subjectTimers = {}; // Store timer for each subject
        let subjectNames = {}; // Store subject names
        let subjectQuestionCounts = {}; // Store question counts for each subject
        let currentSubjectCode = ''; // Track current subject code
        let currentSubjectTime = 0; // Time for current subject
        let subjectStartTime = 0; // When current subject started
        let subjectTimerInterval; // Timer for current subject

        // Empty question bank - all data will come from Google Sheets
        let questionBank = {};
        let mediaStream;         // Stores video+audio stream
        let mediaRecorder;       // Object that records the stream
        let recordedChunks = []; // Stores chunks of recorded video
        let recognition;         // For speech-to-text
        let isRecording = false;
        let timerInterval;       // For the countdown timer

        // Function to update the summary panel with subject names
        function updateSummaryPanel() {
            const totalSubjects = Object.keys(subjectNames).length;
            const totalQuestions = allQuestions.length;
            
            // Calculate total time in minutes and seconds
            const minutes = Math.floor(timerDuration / 60);
            const seconds = timerDuration % 60;
            const timeText = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
            
            totalSubjectsEl.textContent = totalSubjects;
            totalQuestionsEl.textContent = totalQuestions;
            totalTimeEl.textContent = timeText;
            
            // Add subjects list to summary
            let subjectsHTML = '<div class="subjects-list-title">Subjects Included:</div>';
            for (const [code, name] of Object.entries(subjectNames)) {
                const questionCount = subjectQuestionCounts[code] || 0;
                const timeLimit = subjectTimers[code] || 60;
                const minutes = Math.floor(timeLimit / 60);
                const seconds = timeLimit % 60;
                
                subjectsHTML += `
                    <div class="subject-summary">
                        <span class="subject-name">${name}</span>
                        <span class="subject-stats">${questionCount} Qs, ${minutes}:${seconds.toString().padStart(2, '0')}m</span>
                    </div>
                `;
            }
            subjectsListEl.innerHTML = subjectsHTML;
        }

        // Function to fetch data from Google Sheets
        async function fetchDataFromGoogleSheets() {
            try {
                // Show loading indicator
                const loadingIndicator = document.createElement('div');
                loadingIndicator.innerHTML = '<span class="loading"></span> Loading subjects...';
                loadingIndicator.className = 'message system';
                chatMessages.appendChild(loadingIndicator);
                
                // Replace this URL with your actual Google Sheets API URL
                // Format: https://docs.google.com/spreadsheets/d/{YOUR_SHEET_ID}/gviz/tq?tqx=out:json
                const sheetURL = "https://docs.google.com/spreadsheets/d/1W7omv5Q2GMI4-3jz61ZmH-H1x_V1YRG-xz2EfkdseDM/gviz/tq?tqx=out:json";
                const response = await fetch(sheetURL);
                
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }
                
                const text = await response.text();
                // Google Sheets returns JSONP, so we need to parse it
                const jsonData = JSON.parse(text.substr(47).slice(0, -2));
                
                // Process the data from Google Sheets
                const rows = jsonData.table.rows;
                
                // Create a new question bank from the sheet data
                const newQuestionBank = {};
                
                rows.forEach(row => {
                    const subjectCode = row.c[0]?.v?.toString().toLowerCase() || '';
                    const subjectName = row.c[1]?.v || subjectCode;
                    const timer = row.c[2]?.v ? parseInt(row.c[2].v) : 60;
                    
                    // Store timer and name for this subject
                    if (subjectCode) {
                        subjectTimers[subjectCode] = timer;
                        subjectNames[subjectCode] = subjectName;
                        timerDuration += timer; // Add to total time
                    }
                    
                    // Extract questions (starting from column 3)
                    const subjectQuestions = [];
                    for (let i = 3; i < row.c.length; i++) {
                        if (row.c[i] && row.c[i].v && row.c[i].v.toString().trim() !== '') {
                            subjectQuestions.push(row.c[i].v.toString().trim());
                        }
                    }
                    
                    // Add questions to question bank
                    if (subjectCode && subjectQuestions.length > 0) {
                        newQuestionBank[subjectCode] = subjectQuestions;
                        subjectQuestionCounts[subjectCode] = subjectQuestions.length;
                        
                        // Add to all questions array
                        allQuestions = allQuestions.concat(subjectQuestions.map(q => ({
                            question: q,
                            subject: subjectCode
                        })));
                    }
                });
                
                // Remove loading indicator
                chatMessages.removeChild(loadingIndicator);
                
                // Update question bank if we got valid data
                if (Object.keys(newQuestionBank).length > 0) {
                    questionBank = newQuestionBank;
                    
                    // Update the summary panel
                    updateSummaryPanel();
                    
                    // Enable start button
                    startBtn.disabled = false;
                } else {
                    addMessage("No valid data found in sheet. Please check your Google Sheets configuration.", 'system');
                    showAlert("Error: No data found in Google Sheets. Please check your configuration.");
                    startBtn.disabled = true;
                }
                
                return true;
            } catch (error) {
                console.error('Error fetching data from Google Sheets:', error);
                
                // Remove loading indicator if it exists
                const loadingIndicators = document.querySelectorAll('.loading');
                loadingIndicators.forEach(indicator => indicator.parentElement.remove());
                
                addMessage("Server error: Could not fetch data from server.", 'system');
                showAlert("Server error: Could not fetch data from server. Please check your internet connection and try again.");
                
                // Disable start button since no data is available
                startBtn.disabled = true;
                
                return false;
            }
        }

        // Display current subject and its questions
        function displayCurrentSubject(subjectCode) {
            currentSubjectContainer.innerHTML = '';
            
            if (!questionBank[subjectCode]) return;
            
            const subjectName = subjectNames[subjectCode] || subjectCode;
            const questionCount = subjectQuestionCounts[subjectCode] || 0;
            const timeLimit = subjectTimers[subjectCode] || 60;
            const minutes = Math.floor(timeLimit / 60);
            const seconds = timeLimit % 60;
            
            const subjectElement = document.createElement('div');
            subjectElement.className = 'current-subject';
            subjectElement.innerHTML = `
                <div class="subject-title">${subjectName}</div>
                <div class="subject-details">
                    <span>Questions: ${questionCount}</span>
                    <span>Time: ${minutes}m ${seconds}s</span>
                </div>
            `;
            
            currentSubjectContainer.appendChild(subjectElement);
            
            const questionsContainer = document.createElement('div');
            questionsContainer.className = 'subject-questions';
            
            questionBank[subjectCode].forEach((question, index) => {
                const questionItem = document.createElement('div');
                questionItem.className = 'question-item';
                questionItem.id = `question-${subjectCode}-${index}`;
                questionItem.innerHTML = `
                    <div class="question-text">Q${index + 1}: ${question}</div>
                `;
                questionsContainer.appendChild(questionItem);
            });
            
            currentSubjectContainer.appendChild(questionsContainer);
            
            // Highlight the first question
            const firstQuestion = document.getElementById(`question-${subjectCode}-0`);
            if (firstQuestion) {
                firstQuestion.classList.add('current');
            }
        }

        // Helper function to format time as mm:ss
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // Update timer color based on remaining time
        function updateTimerColor(percent) {
            if (percent > 50) {
                timerBar.style.background = "linear-gradient(to right, #25D366, #ffcc00)";
                timerText.style.color = "#25D366";
            } else if (percent > 25) {
                timerBar.style.background = "linear-gradient(to right, #ffcc00, #ff9933)";
                timerText.style.color = "#ffcc00";
            } else {
                timerBar.style.background = "linear-gradient(to right, #ff9933, #ff3333)";
                timerText.style.color = "#ff3333";
            }
        }

        //  Initialize speech recognition (if browser supports it)
        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;

                recognition.onresult = (event) => {
                    let interimTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;

                        if (event.results[i].isFinal) {
                            addMessage(transcript, 'user');
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    if (interimTranscript) {
                        const lastMessage = chatMessages.lastChild;
                        if (lastMessage && lastMessage.classList.contains('interim')) {
                            lastMessage.textContent = interimTranscript;
                        } else {
                            const interimElement = document.createElement('div');
                            interimElement.className = 'message user interim';
                            interimElement.textContent = interimTranscript;
                            chatMessages.appendChild(interimElement);
                        }
                    }
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error', event.error);
                    stopRecording(); // Optional: stop recording on error
                };
            } else {
                console.warn('Speech recognition not supported');
                addMessage("Speech recognition not supported in this browser", 'system');
            }
        }

        // Function to add messages to chat
        function addMessage(text, sender) {
            // Remove any temporary (interim) messages
            const interimMessages = document.querySelectorAll('.interim');
            interimMessages.forEach(msg => msg.remove());

            // Create new chat message
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.textContent = text;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTo({
                top: chatMessages.scrollHeight,
                behavior: 'smooth'
            });
        }

        // Display current question in the white question box
        function displayCurrentQuestion() {
            if (currentQuestionIndex < allQuestions.length) {
                const currentQ = allQuestions[currentQuestionIndex];
                const subjectName = subjectNames[currentQ.subject] || currentQ.subject;
                const questionText = `Subject: ${subjectName} - Question ${currentQuestionIndex + 1}: ${currentQ.question}`;
                currentQuestion.textContent = questionText;
                
                // Check if we've moved to a new subject
                if (currentSubjectCode !== currentQ.subject) {
                    // New subject started
                    currentSubjectCode = currentQ.subject;
                    currentSubjectTime = subjectTimers[currentSubjectCode] || 60;
                    subjectStartTime = Date.now();
                    
                    // Display the new subject and its questions
                    displayCurrentSubject(currentSubjectCode);
                    
                    // Start subject timer
                    startSubjectTimer();
                }
                
                // Update question highlighting
                document.querySelectorAll('.question-item').forEach(item => {
                    item.classList.remove('current', 'completed');
                });
                
                // Get the current question index within the subject
                const subjectQuestions = questionBank[currentSubjectCode];
                const subjectQuestionIndex = subjectQuestions.indexOf(currentQ.question);
                
                if (subjectQuestionIndex >= 0) {
                    // Highlight current question
                    const currentQuestionElement = document.getElementById(`question-${currentSubjectCode}-${subjectQuestionIndex}`);
                    if (currentQuestionElement) {
                        currentQuestionElement.classList.add('current');
                    }
                    
                    // Mark previous questions as completed
                    for (let i = 0; i < subjectQuestionIndex; i++) {
                        const prevQuestionElement = document.getElementById(`question-${currentSubjectCode}-${i}`);
                        if (prevQuestionElement) {
                            prevQuestionElement.classList.add('completed');
                        }
                    }
                }
            } else {
                currentQuestion.textContent = "All questions completed. Ready to submit.";
                nextBtn.disabled = true;
                submitBtn.disabled = false;
                
                // Clear subject timer
                clearInterval(subjectTimerInterval);
            }
        }

        // Start subject timer
        function startSubjectTimer() {
            clearInterval(subjectTimerInterval);
            
            let timeLeft = currentSubjectTime;
            
            subjectTimerInterval = setInterval(() => {
                timeLeft--;
                
                if (timeLeft <= 0) {
                    clearInterval(subjectTimerInterval);
                    // Auto move to next question when subject time expires
                    if (currentQuestionIndex < allQuestions.length - 1) {
                        nextQuestion();
                    }
                }
            }, 1000);
        }

        // Start timer function
        function startTimer() {
            clearInterval(timerInterval);
            
            let timeLeft = timerDuration; // seconds
            
            // Initialize timer display
            timerText.textContent = formatTime(timeLeft);
            timerBar.style.width = '100%';
            updateTimerColor(100);

            timerInterval = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerText.textContent = `${minutes}:${seconds.toString().padStart(2,'0')}`;

                // Update timer bar width and color
                const percent = (timeLeft / timerDuration) * 100;
                timerBar.style.width = `${percent}%`;
                updateTimerColor(percent);

                timeLeft--;

                // Auto-submit when timer ends
                if (timeLeft < 0) {
                    clearInterval(timerInterval);
                    addMessage("‚è∞ Time is up! Auto-submitting your video.", 'system');
                    uploadRecordedVideo();
                }
            }, 1000);
        }

        // Start recording video, audio, speech-to-text, and timer
        async function startRecording() {
            try {
                if (allQuestions.length === 0) {
                    showAlert("No questions available!");
                    return;
                }
                
            
                
                currentQuestionIndex = 0; // Reset question index on start

                //  Access camera & microphone
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                videoElement.srcObject = mediaStream;

                //  Setup MediaRecorder
                mediaRecorder = new MediaRecorder(mediaStream);
                recordedChunks = [];
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };
                mediaRecorder.start(100);

                //  Start speech recognition if available
                if (recognition) {
                    recognition.start();
                }
                isRecording = true;
                
                // Update status indicator
                statusIndicator.classList.add('status-recording');

                startBtn.disabled = true;
                nextBtn.disabled = false;

                displayCurrentQuestion();
                startTimer();

            } catch (error) {
                console.error('Error accessing media devices:', error);
                addMessage("Error accessing camera/microphone", 'system');
            }
        }

        // Move to next question
        function nextQuestion() {
            if (isRecording) {
                currentQuestionIndex++;
                displayCurrentQuestion();

                if (currentQuestionIndex >= allQuestions.length) {
                    nextBtn.disabled = true;
                    submitBtn.disabled = false;
                    
                    // Mark all questions as completed
                    document.querySelectorAll('.question-item').forEach(item => {
                        item.classList.add('completed');
                    });
                }
            }
        }

        // Upload recorded video to server
        function uploadRecordedVideo() {
            if (recordedChunks.length === 0) {
                showAlert("‚ö†Ô∏è No recording available to upload!");
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = "Submitting...";

            const username = localStorage.getItem("username") || "user";
            const mobile = localStorage.getItem("mobile") || "0000000000";

            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const finalFilename = `video.webm`;  // simple filename
            const file = new File([blob], finalFilename, { type: 'video/webm' });

            const formData = new FormData();
            formData.append("video", file);
            formData.append("username", username);
            formData.append("mobile", mobile);

            fetch("https://video-analysis-backend-2l85.onrender.com/upload", {
                method: "POST",
                body: formData
            })
            .then(res => {
                if (!res.ok) throw new Error("‚ùå Server error");
                return res.json();
            })
            .then(data => {
                console.log("‚úÖ Upload success:", data);
                const message = "‚úÖ Thank You! Your Submission has been sent successfully!";
                localStorage.setItem('uploadResultMessage', message);

                // Optional: trigger analysis
                fetch("http://localhost:5000/analyze-drive", {
                    method: "GET",
                    mode: "no-cors"
                }).catch(err => console.warn("Analyze-drive trigger failed:", err));

                // Redirect to result page
                sessionStorage.setItem("fromDashboard", "true");
                window.location.replace("result.html");
            })
            .catch(err => {
                console.error("‚ùå Upload failed:", err);
                const errorMsg = "‚ö†Ô∏è Something went wrong. Please try again.";
                localStorage.setItem('uploadResultMessage', errorMsg);
                sessionStorage.setItem("fromDashboard", "true");
                window.location.replace("result.html");
            });
        }

        // Event listeners
        startBtn.addEventListener('click', () => {
            console.log("Start button clicked");
            startRecording();
        });

        nextBtn.addEventListener('click', () => {
            console.log("Next button clicked");
            nextQuestion();
        });

        submitBtn.addEventListener('click', () => {
            console.log("Submit button clicked");
            uploadRecordedVideo();
        });

        // Initialize speech recognition
        initSpeechRecognition();
        
        // Fetch data from Google Sheets when page loads
        fetchDataFromGoogleSheets();
    });
</script>
</body>
</html>




